import e from"array-move";import{dequal as t}from"dequal";import r from"prop-types";import a from"react";import{TextField as l,Grid as n,IconButton as o,Switch as i,FormGroup as s,FormControlLabel as u,Radio as c,Typography as d,Button as p}from"@material-ui/core";import{makeStyles as m}from"@material-ui/core/styles";import{RemoveCircleOutline as v,AddCircleOutline as f}from"@material-ui/icons";import{Autocomplete as y,ToggleButtonGroup as b,ToggleButton as g}from"@material-ui/lab";import{Container as h,Draggable as E}from"react-smooth-dnd";import{parseISO as C,startOfDay as O,format as q}from"date-fns";import x from"@date-io/date-fns";import w from"@material-ui/icons/Close";import{DatePicker as B,MuiPickersUtilsProvider as I}from"@material-ui/pickers";function T(){return(T=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}var R=a.createContext({dispatch:null,filter:[],filtersByValue:{},flattenedFilters:[],maxLevel:null,operators:[],operatorsByType:{},operatorsByValue:{}});const L=[{label:"equal to",value:"equal",types:["date","integer","number","radio","select","switch","text"]},{label:"not equal to",value:"not_equal",types:["date","integer","number","radio","select","switch","text"]},{label:"contains",value:"contains",types:["text"]},{label:"does not contain",value:"not_contains",types:["text"]},{label:"less than",value:"less",types:["number","integer"]},{label:"greater than",value:"greater",types:["number","integer"]},{label:"less or equal to",value:"less_equal",types:["number","integer"]},{label:"greater or equal to",value:"greater_equal",types:["number","integer"]},{label:"before than",value:"before",types:["date"]},{label:"after than",value:"after",types:["date"]},{label:"before or equal to",value:"before_equal",types:["date"]},{label:"after or equal to",value:"after_equal",types:["date"]},{label:"in",value:"in",types:["multiselect"]},{label:"not in",value:"not_in",types:["multiselect"]},{label:"is null",value:"null",types:["date","integer","number","multiselect","radio","select","switch","text"]},{label:"is not null",value:"not_null",types:["date","integer","number","multiselect","radio","select","switch","text"]}],P=a.memo(e=>{const t=a.useContext(R),{field:r,id:n,testId:o}=e,{dispatch:i,filtersByValue:s,flattenedFilters:u,operatorsByType:c}=t;return a.createElement(y,{fullWidth:!0,"data-testid":"field-"+o,disableClearable:!0,groupBy:e=>e.group,getOptionLabel:e=>e.label,getOptionSelected:(e,t)=>e.value===t.value,options:u,renderInput:e=>a.createElement(l,T({},e,{placeholder:"Field",size:"small",variant:"outlined"})),style:{minWidth:250},value:r?s[r]:null,onChange:(e,t)=>{const r=t?t.value:null,{type:a}=s[r],l=c[a];i({type:"set-field",id:n,operator:(null==l?void 0:l.length)>0?l[0].value:null,value:r})}})},(e,r)=>t(e,r));P.propTypes={field:r.string,id:r.number.isRequired,testId:r.string.isRequired},P.whyDidYouRender=!1;const k=a.memo(e=>{const t=a.useContext(R),{field:r,id:n,operator:o,testId:i}=e,{dispatch:s,filtersByValue:u,operatorsByType:c,operatorsByValue:d}=t,p=r?u[r]:null;return a.createElement(y,{fullWidth:!0,"data-testid":"operator-"+i,disableClearable:!0,getOptionLabel:e=>e.label,getOptionSelected:(e,t)=>e.value===t.value,options:p?c[p.type]:[],renderInput:e=>a.createElement(l,T({},e,{placeholder:"Operator",size:"small",variant:"outlined"})),style:{minWidth:200},value:o?d[o]:null,onChange:(e,t)=>{const{value:r}=t;s({type:"set-operator",id:n,value:r})}})},(e,r)=>t(e,r));k.propTypes={field:r.string,id:r.number.isRequired,operator:r.string,testId:r.string.isRequired},k.whyDidYouRender=!1;const N=m(e=>({clearButton:{margin:e.spacing(1)},clearCell:{marginLeft:-e.spacing(.5),marginTop:t=>t.label?e.spacing(1.5):"none"}}));function S(e){return e?("string"==typeof e&&(e=C(e)),e=O(e)):null}const j=e=>{const t=N(e),[r,l]=a.useState(S(e.value));function i(t){t=S(t),l(t),e.onChange&&e.onChange(t)}return a.useEffect(()=>{const t=S(e.value);l(t)},[e.value]),a.createElement(n,{container:!0},a.createElement(n,{item:!0},a.createElement(I,{utils:x},a.createElement(B,T({},function(){const t=T({},e,{InputLabelProps:T({},e.InputLabelProps,{shrink:!0}),variant:"inline"});return delete t.clearable,t}(),{value:r,onChange:i})))),e.clearable&&a.createElement(n,{item:!0,className:t.clearCell},a.createElement(o,{"aria-label":"clear",className:t.clearButton,"data-testid":e["data-testid"]+"-clear",size:"small",onClick:()=>i(null)},a.createElement(w,{fontSize:"inherit"}))))};j.defaultProps=T({},B.defaultProps,{autoOk:!0,"data-testid":"date-picker",format:"PPP"}),j.propTypes=T({},B.propTypes,{"data-testid":r.string,clearable:r.bool});const V=m(e=>({label:{fontSize:e.typography.fontSize}})),z=e=>null!=e?e:"",D=new Set(["date","integer","multiselect","number","radio","select","switch","text"]),F=a.memo(e=>{const t={formControlLabel:V()},r=a.useContext(R),{field:n,id:o,operator:d,value:p}=e,{customOperators:m,dispatch:v,filtersByValue:f}=r;if(/null/i.test(d))return a.createElement("span",null);const b="value-"+e.testId,g=n?T({},f[n]):{type:null};if(!D.has(g.type)){const e=m[g.type];g.type=null==e?void 0:e.type}switch(g.type){case"date":return a.createElement(j,{clearable:!0,"data-testid":b,value:p||null,onChange:e=>{const t=e?q(e,"yyyy-MM-dd"):null;v({type:"set-value",id:o,value:t})}});case"integer":return a.createElement(l,{"data-testid":b,value:z(p),onChange:e=>{const t=e.target.value,r=t.length>0?Number(t):null;r!==p&&v({type:"set-value",id:o,value:r})},onKeyPress:e=>{/\D/.test(e.key)&&e.preventDefault()}});case"multiselect":return a.createElement(y,{filterSelectedOptions:!0,fullWidth:!0,multiple:!0,openOnFocus:!0,"data-testid":b,disableCloseOnSelect:!0,getOptionLabel:e=>e.label,getOptionSelected:(e,t)=>e.value===t.value,limitTags:-1,options:g.options,renderInput:e=>a.createElement(l,e),size:"small",style:{paddingTop:4,width:"auto"},value:g.options.filter(e=>null==p?void 0:p.includes(e.value)),onChange:(e,t)=>{const r=(t||[]).map(e=>e.value);v({type:"set-value",id:o,value:r})}});case"number":return a.createElement(l,{"data-testid":b,value:z(p),onChange:e=>{const{value:t}=e.target,r=t.replace(/[^.\d]|^0+/g,"").replace(/^(\d*\.?)|(\d*)\.?/g,"$1$2")||null;r!==p&&v({type:"set-value",id:o,value:r})}});case"radio":return a.createElement(s,{row:!0},a.createElement(u,{classes:t.formControlLabel,control:a.createElement(c,{checked:!0===p,color:"primary","data-testid":b+"-true",name:b,value:p,onChange:()=>{v({type:"set-value",id:o,value:!0})}}),label:"True",value:p}),a.createElement(u,{classes:t.formControlLabel,control:a.createElement(c,{checked:!1===p,color:"primary","data-testid":b+"-false",name:b,value:p,onChange:()=>{v({type:"set-value",id:o,value:!1})}}),label:"False",value:p}));case"select":return a.createElement(y,{"data-testid":b,getOptionLabel:e=>e.label,getOptionSelected:(e,t)=>e.value===t.value,options:g.options,renderInput:e=>a.createElement(l,e),style:{width:250},value:g.options.find(e=>p===e.value),onChange:(e,t)=>{v({type:"set-value",id:o,value:t?t.value:null})}});case"switch":return a.createElement(i,{color:"primary","data-testid":b,checked:p||!1,onChange:e=>{v({type:"set-value",id:o,value:e.target.checked})}});default:return a.createElement(l,{fullWidth:!0,"data-testid":b,value:p||"",onChange:e=>{const{value:t}=e.target;v({type:"set-value",id:o,value:t})}})}},(e,r)=>t(e,r));F.propTypes={field:r.string,id:r.number.isRequired,operator:r.string,testId:r.string.isRequired,value:r.any},F.whyDidYouRender=!1;const _=e=>({removeButton:{marginRight:e.spacing(-1),marginTop:e.spacing(.75)},removeIcon:{fill:"rgba(255, 0, 0, 0.9)"}}),$=m(e=>T({},_(e),{container:{"& > div":{marginBottom:e.spacing(.5),marginTop:e.spacing(.5)},cursor:"move"},valueGridItem:{flex:"auto"}})),M=e=>{const t=$(),r=a.useContext(R),{id:l,level:i,position:s,rule:u}=e,{combinator:c,field:d,operator:p,rules:m,value:f}=u,{dispatch:y}=r,b=`${i}-${s}`;return c?a.createElement(A,{combinator:c,id:l,level:i+1,rules:m}):a.createElement(n,{container:!0,className:t.container,"data-testid":"rule-"+b,spacing:2},a.createElement(n,{item:!0},a.createElement(o,{className:t.removeButton,"data-testid":`rule-${b}-remove`,size:"small",onClick:()=>{y({type:"remove-node",id:l})}},a.createElement(v,{className:t.removeIcon}))),a.createElement(n,{item:!0},a.createElement(P,{field:d,id:l,testId:b})),a.createElement(n,{item:!0},a.createElement(k,{field:d,id:l,operator:p,testId:b})),a.createElement(n,{item:!0,className:t.valueGridItem},a.createElement(F,{field:d,id:l,operator:p,testId:b,value:f})))};M.propTypes={id:r.number.isRequired,level:r.number.isRequired,position:r.number.isRequired,rule:r.object.isRequired};const W=m(e=>T({actionButton:{"& svg":{marginRight:e.spacing(.5),marginTop:e.spacing(.25)},textTransform:"none"},combinator:{height:36,padding:e.spacing(0,1.5)},group:{borderLeft:t=>t.level>0?"2px solid "+e.palette.divider:"none",paddingLeft:e.spacing(1.5),marginBottom:e.spacing(.5),marginTop:t=>t.level>0?e.spacing(.5):"none"}},_(e))),A=e=>{const t=W(e),r=a.useContext(R),{combinator:l,combinators:i,id:s,level:u,rules:c}=e,m="group-"+u,{dispatch:y,maxLevels:C}=r;return u<=C?a.createElement(n,{container:!0,className:t.group,"data-testid":m,direction:"column",spacing:1},a.createElement(n,{item:!0},a.createElement(n,{container:!0,spacing:2},a.createElement(n,{item:!0},a.createElement(o,{className:t.removeButton,"data-testid":m+"-remove",disabled:0===u,size:"small",onClick:()=>{y({type:"remove-node",id:s})}},a.createElement(v,{className:u>0?t.removeIcon:null}))),a.createElement(n,{item:!0},a.createElement(b,{exclusive:!0,size:"small",value:l,onChange:(e,t)=>{t&&y({type:"set-combinator",id:s,value:t})}},i.map(e=>a.createElement(g,{key:e.value,"data-testid":`${m}-combinator-${e.value}`,className:t.combinator,value:e.value},a.createElement(d,{variant:"body2"},e.label))))),a.createElement(n,{item:!0},a.createElement(p,{className:t.actionButton,color:"primary","data-testid":m+"-add-rule",onClick:()=>{y({type:"add-rule",id:s})}},a.createElement(f,null),"Rule")),u<C&&a.createElement(n,{item:!0},a.createElement(p,{className:t.actionButton,color:"primary","data-testid":m+"-add-group",onClick:()=>{y({type:"add-group",id:s})}},a.createElement(f,null),"Group")))),(null==c?void 0:c.length)>0&&a.createElement(n,{item:!0},a.createElement(h,{onDrop:({addedIndex:e,removedIndex:t})=>{y({type:"move-rule",addedIndex:e,id:s,removedIndex:t})}},c.map((e,t)=>a.createElement(E,{key:e.id},a.createElement(M,{id:e.id,level:u,position:t,rule:e})))))):a.createElement("span",null)};function G(e){const t={};return e.forEach(e=>{(e.options||[]).forEach(e=>{const{value:r}=e;if(Object.prototype.hasOwnProperty.call(t,r))throw new Error("Duplicated filter: "+r);t[r]=T({},e)})}),t}function J(e){const t=[];return e.forEach(e=>{e.options.forEach(r=>{t.push(T({group:e.label},r))})}),t}function Y(e){return e.forEach(e=>{e.options=e.options.sort((e,t)=>e.label.localeCompare(t.label))}),e}function Q(e,t){const r={};return[...new Set([].concat(...e.map(e=>e.types)))].sort().forEach(t=>{Object.prototype.hasOwnProperty.call(r,t)||(r[t]=[]),e.forEach(e=>{e.types.includes(t)&&r[t].push({label:e.label,value:e.value})})}),Object.entries(t||{}).forEach(([e,t])=>{r[e]=t.options}),Object.keys(r).forEach(e=>{r[e]=r[e].sort((e,t)=>e.label.localeCompare(t.label))}),r}function K(e,t){const r={};return e.forEach(e=>{const{value:t}=e;if(Object.prototype.hasOwnProperty.call(r,t))throw new Error("Duplicated operator: "+t);r[t]=T({},e)}),Object.values(t||{}).forEach(e=>{e.options.forEach(t=>{Object.prototype.hasOwnProperty.call(r,t.value)||(r[t.value]={types:[]}),r[t.value]=T({},r[t.value],{label:t.label,value:t.value});const{types:a}=r[t.value];a.includes(e.type)||a.push(e.type)})}),r}A.defaultProps={combinator:"and",combinators:[{label:"AND",value:"and"},{label:"OR",value:"or"}],rules:[]},A.propTypes={combinator:r.string,combinators:r.array,id:r.number.isRequired,level:r.number.isRequired,rules:r.array};const H=(e,t)=>{if(t.id===e)return t;if(t.rules)for(const r of t.rules){const t=H(e,r);if(t)return t}return null},U=(e,t,r)=>{if(r||(r=t),t.id===e)return r;if(t.rules){r=t;for(const a of t.rules){const t=U(e,a,r);if(t)return t}}return null};function X(e,t){const r="random"===t;return r?e.id=e.id||Math.random():delete e.id,e.rules.map(e=>(r?e.id=e.id||Math.random():delete e.id,e.rules&&X(e,t),e)),e}function Z(e){return X(e=function(e){return JSON.parse(JSON.stringify(e))}(e))}function ee(e){if(0===Object.getOwnPropertyNames(e).length)return!1;for(const t of e.rules)if(t.rules){if(!ee(t))return!1}else if(!te(t))return!1;return!0}function te(e){if(!e.field||!e.operator)return!1;if(/null/gi.test(e.operator))return!0;const{value:t}=e;return Array.isArray(t)?(null==t?void 0:t.length)>0:/string/.test(typeof t)?Boolean(null==t?void 0:t.trim()):null!=t}function re(e,t){let r=ee(e);return r&&(null==t?void 0:t.filtersByValue)&&(r=function e(t,r){for(const a of t.rules)if(a.rules){if(!e(a,r))return!1}else if(!Object.prototype.hasOwnProperty.call(r,a.field))return!1;return!0}(e,t.filtersByValue)),r}const ae=function(){return{field:null,id:Math.random(),operator:null,value:null}},le=function(){return{combinator:"and",id:Math.random(),rules:[ae()]}};function ne(t,r){const a=T({},t);switch(r.type){case"add-group":return H(r.id,a).rules.push(le()),a;case"add-rule":return H(r.id,a).rules.push(ae()),a;case"move-rule":{const{addedIndex:t,id:l,removedIndex:n}=r,o=H(l,a);return o.rules=e(o.rules,n,t),a}case"remove-node":{const e=U(r.id,a);return e.rules=e.rules.filter(e=>e.id!==r.id),a}case"reset-query":{let{query:e}=r;return e=X(e,"random"),e}case"set-combinator":return H(r.id,a).combinator=r.value,a;case"set-field":{const e=H(r.id,a);return e.field=r.value,e.operator=r.operator,e.value=null,a}case"set-operator":{const e=H(r.id,a);return e.operator=r.value,/null/.test(r.value)&&(e.value=null),a}case"set-value":return H(r.id,a).value=r.value,a;default:return a}}const oe=a.memo(e=>{const[t,r]=a.useReducer(ne,e.query||{combinator:"and",rules:[]}),[l,n]=a.useState(null);return a.useEffect(()=>{const{customOperators:t,filters:a,maxLevels:l,operators:o}=e;n({customOperators:t,dispatch:r,filters:e.sortFilters?Y(a):a,filtersByValue:G(a),flattenedFilters:J(a),maxLevels:l,operators:o,operatorsByValue:K(o,t),operatorsByType:Q(o,t)})},[r,e,e.filters,e.maxLevels,e.operators]),a.useEffect(()=>{var t;(null===(t=e.query)||void 0===t?void 0:t.id)||r({type:"reset-query",query:e.query})},[e.query]),a.useEffect(()=>{if(e.onChange){const r=re(t,l);e.onChange(t,r)}},[l,e,e.onChange,t]),t.id&&l?a.createElement(R.Provider,{value:l},a.createElement(A,{combinator:t.combinator,id:t.id,level:0,rules:t.rules}),e.debug&&a.createElement(a.Fragment,null,a.createElement("pre",null,JSON.stringify(Z(t),null,4)),a.createElement("pre",null,"Valid? ",re(t,l)?"true":"false"))):a.createElement("span",null)},(e,r)=>t(e.query,r.query));oe.formatQuery=Z,oe.isQueryValid=ee,oe.operators=L,oe.defaultProps={customOperators:{},debug:!1,filters:[],maxLevels:1,operators:[...L],onChange:null,query:le(),sortFilters:!0},oe.propTypes={customOperators:r.object,debug:r.bool,filters:r.array,maxLevels:r.number,operators:r.array,onChange:r.func,query:r.object,sortFilters:r.bool};export default oe;
//# sourceMappingURL=index.modern.js.map
